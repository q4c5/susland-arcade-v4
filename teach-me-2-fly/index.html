
<!doctype html>
<html>
	<head>
		<title>TEACH ME TO FLY</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		
		<script type="text/javascript" src='/analytics.js' async ></script>	
		<script src="/teach-me-2-fly/Three.js"></script>
		<script src="/teach-me-2-fly/Detector.js"></script>
		<script src="/FullScreen.js"></script>
		<script src="threex/THREEx.WindowResize.js"></script>
		<script src="LinkedInHack.js"></script>

		<script src="js/loaders/ColladaLoader.js"></script>
		<link  href="css/main.css" rel="stylesheet"/>

	<script type="text/javascript">


var GAME=(function() {
  var hide = function(id) { document.getElementById(id).style.display="none"; },
      show = function(id) { document.getElementById(id).style.display="block"; };

  return {
    running: false,
    
    win: function() {
      show("win");
      this.running=false;
  
    },

    loose: function() {
      if (!this.running) return false;
      try{
	LinkedInHack();
      } catch(e){
      }
      crashSound.play();
      show("loose");
      this.running=false;
    },

    start: function() {
      hide("start");
      this.running=true;
      music.play();
    },

    restart: function() {
      //crashSound.currentTime=0;
      NAVIGATION.reset();
      hide("win");
      hide("loose");
      this.running=true;
      music.currentTime=0;
    },

    init: function() {
      show("start");
      if( !init() ) animate();
      MAPS.set_level(0);
      NAVIGATION.set();      
    }

  }
})();


var MAPS=(function(){
  var maps=[];
maps[0]={
mapString: "\
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF F0 70 30 10 00 00 10 30 70 F0 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF F0 70 30 10 00 00 10 30 70 F0 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF F0 00 00 00 00 00 00 00 00 0F FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 F0 00 00 F3 00 FF \
FF 00 00 00 00 00 00 00 00 FF 00 FF \
FF 00 0F 00 00 F1 00 FF 00 00 00 FF \
FF 00 00 00 00 00 FF 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 FF 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 FF 00 FF 00 FF 00 FF 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 FF 00 00 FF \
FF 00 00 00 FF 00 FF 00 00 00 00 FF \
FF 00 00 00 00 00 00 FF 00 00 00 FF \
FF 00 00 00 00 00 FF FF FF FF FF FF \
FF 00 00 00 00 FF 00 00 00 00 00 FF \
FF 00 00 00 FF 00 FF FF FF FF FF FF \
FF FF FF AA FF 00 00 FF FF FF FF FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF FF FF AA AA FF FF FF FF FF FF FF \
FF FF FF 00 00 00 00 FF FF FF FF FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 32 00 EA EA EF EF FF FF A8 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 FF 00 00 00 00 FF \
FF FF FF FF 0F 0F 0F FF FF FF FF 00 \
FF 00 00 00 00 00 00 00 00 00 00 00 \
FF 00 00 87 00 00 44 00 A0 00 00 00 \
FF FF FF 00 00 00 B3 FF FF 00 00 00 \
FF FF FF 00 00 0A FF FF FF 00 00 00 \
00 FF FF 00 FF FF 00 FF FF FF 0F F0 \
00 00 0F 00 00 F0 00 FF FF FF FF 00 \
FF 00 FF 00 FF 00 00 FF FF 00 00 00 \
00 FF FF 18 FA 00 00 32 56 87 95 00 \
00 FF FF 3C FA 0F FF 32 56 87 00 00 \
00 FF FF 7E FA 0F FF 32 56 87 00 00 \
00 FF FF 8E FA 0F FF 32 56 87 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
00 00 00 00 00 00 00 00 00 00 00 00 \
FF 00 00 FF 00 FF 00 FF 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 FF 00 FF 00 FF 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 FF 00 FF 00 FF 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF AA 55 AA 55 AA 55 AA 55 AA 55 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 55 AA 55 AA 55 AA 55 AA 55 AA FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF AA 55 AA 55 AA 55 AA 55 AA 55 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 55 AA 55 AA 55 AA 55 AA 55 AA FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 FF FF 00 00 00 00 FF \
FF 00 00 00 FF 00 00 FF 00 00 00 FF \
FF 00 00 FF 00 00 00 00 FF 00 00 FF \
FF 00 FF 00 00 FF FF 00 00 FF 00 FF \
FF 00 F0 00 00 FF FF 00 00 F0 00 FF \
FF 00 F0 00 00 FF FF 00 00 F0 00 FF \
FF 00 F0 00 00 00 00 00 00 F0 00 FF \
FF 00 F0 00 00 00 00 00 00 F0 00 FF \
00 FF FF 00 00 00 00 00 00 FF FF FF \
00 00 FF 00 00 00 00 00 00 00 FF 00 \
00 FF 00 00 00 00 00 00 00 00 FF 00 \
00 00 00 00 00 10 10 10 00 00 FF 00 \
FF 00 00 00 00 10 00 10 00 00 00 FF \
FF 00 00 00 00 10 10 10 00 00 00 FF \
FF 00 10 00 00 00 00 00 00 00 00 FF \
FF 10 F0 10 00 00 00 00 00 00 00 FF \
FF F0 F1 F0 10 00 00 00 00 00 00 FF \
FF F1 F3 F1 F0 00 00 00 00 00 00 FF \
FF F3 FF F3 F1 00 00 00 00 00 00 FF \
FF FF FF 00 FF F0 FF F0 FF F0 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 FF AA A4 FF A4 33 33 00 00 FF \
FF 00 00 00 FF 00 A4 33 33 00 00 FF \
FF 00 00 00 00 00 A4 00 00 00 00 FF \
FF 00 00 00 00 00 A4 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF DF DF DF DF DF DF DF DF DF DF FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 08 FF 08 FF 08 FF 08 FF 08 FF FF \
FF 08 08 08 08 08 08 08 08 08 00 FF \
FF 0F 00 0F 00 0F 00 0F 00 0F 00 FF \
FF 8F 00 8F 00 8F 00 8F 00 8F 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF FB FB FB FB FB FB FB FB FB FB FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF E7 C3 81 81 81 81 81 81 C3 E7 FF \
FF FF E7 C3 C3 C3 C3 C3 C3 E7 FF FF \
FF FF FF E7 E7 E7 E7 E7 E7 FF FF FF \
FF FF FF E7 E7 E7 E7 E7 E7 FF FF FF \
FF FF FF E7 E7 E7 E7 E7 E7 FF FF FF \
FF FF FF FF E7 E7 E7 E7 FF FF FF FF \
FF FF FF FF E7 FF FF E7 FF FF FF FF \
FF FF FF FF E7 FF FF E7 FF FF FF FF \
FF 81 81 A5 A5 BD BD A5 A5 81 81 FF \
FF 81 81 A5 A5 BD BD A5 A5 81 81 FF \
FF 81 81 87 85 9D 9D 85 87 81 81 FF \
FF 81 81 DF 85 C5 C5 85 DF 81 81 FF \
FF 85 85 C5 9D C5 DD 85 C5 85 87 FF \
FF 85 85 C5 01 01 01 01 C5 85 87 FF \
FF 8D C5 01 01 01 01 01 01 C5 8F FF \
FF CD 01 01 00 00 00 01 01 01 CD FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF EE BB 80 BB EE 03 DE 73 3D E7 FF \
FF EF BB 89 BB FF 63 FF 73 3D EF FF \
FF C5 B5 89 BB C7 03 FF 43 05 FF FF \
FF 45 01 01 0F 07 03 FF 03 05 0F FF \
FF 00 00 00 00 00 00 FF 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 06 42 7E 40 00 72 52 5E 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
FF 00 00 00 00 00 00 00 00 00 00 FF \
",

charsPerElement: 2
};

  var width=12,
    cubeScale=10,
    slope=1*Math.PI/12,
    mapMesh=false,
    collider=false,
    ymax=0,
    ground=false
    cubesMesh=false;




  return {
      parse_level: function(lvl) {

	    var cubeGeometry, roofGeometry;
	    var posZ=new THREE.PlaneGeometry(cubeScale, cubeScale), negZ=new THREE.PlaneGeometry(cubeScale, cubeScale), posX=new THREE.PlaneGeometry(cubeScale, cubeScale), negX=new THREE.PlaneGeometry(cubeScale, cubeScale), posY=new THREE.PlaneGeometry(cubeScale, cubeScale), negY=new THREE.PlaneGeometry(cubeScale, cubeScale),
	    matrix=new THREE.Matrix4();
	    matrix.makeRotationZ(Math.PI/2);
	    matrix.translate({x:0, y:cubeScale/2, z:0});
	    negX.applyMatrix(matrix);

	    matrix.makeRotationZ(-Math.PI/2);
	    matrix.translate({x:0, y:cubeScale/2, z:0});
	    posX.applyMatrix(matrix);

	    matrix.makeRotationX(Math.PI/2);
	    matrix.translate({x:0, y:cubeScale/2, z:0});
	    negZ.applyMatrix(matrix);

	    matrix.makeRotationX(-Math.PI/2);
	    matrix.translate({x:0, y:cubeScale/2, z:0});
	    posZ.applyMatrix(matrix);

	    matrix.makeRotationY(Math.PI/2);
	    matrix.translate({x:0, y:cubeScale/2, z:0});
	    negY.applyMatrix(matrix);

	    matrix.makeRotationY(-Math.PI/2);
	    matrix.translate({x:0, y:cubeScale/2, z:0});
	    posY.applyMatrix(matrix);

	    cubeGeometry=negX;
	    THREE.GeometryUtils.merge(cubeGeometry, posX);
	    THREE.GeometryUtils.merge(cubeGeometry, posZ);
	    THREE.GeometryUtils.merge(cubeGeometry, negZ); 

	    roofGeometry=negY;
	    THREE.GeometryUtils.merge(roofGeometry, posY); 



	var building_textures = [
	  THREE.ImageUtils.loadTexture("images/buildings/1.jpg"),
	  THREE.ImageUtils.loadTexture("images/buildings/2.jpg"),
	  THREE.ImageUtils.loadTexture("images/buildings/3.jpg"),
	  THREE.ImageUtils.loadTexture("images/buildings/4.jpg"),
	  THREE.ImageUtils.loadTexture("images/buildings/5.jpg")
	];
	building_textures[0].repeat.set( 1, 1 );
	building_textures[1].repeat.set( 1, 1 );
	building_textures[2].repeat.set( 1, 1 );
	building_textures[3].repeat.set( 1, 1 );
	building_textures[4].repeat.set( 1, 1 );


	building_textures.map(function(building_texture) { building_texture.wrapS = building_texture.wrapT = THREE.RepeatWrapping; });				
  
	var building_materials = [
	  new THREE.MeshPhongMaterial( { map:building_textures[0], color: 0xffffff, ambient: 0x777777, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } ),
	  new THREE.MeshPhongMaterial( { map:building_textures[1], color: 0xffffff, ambient: 0x777777, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } ),
	  new THREE.MeshPhongMaterial( { map:building_textures[2], color: 0xffffff, ambient: 0x777777, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } ),
	  new THREE.MeshPhongMaterial( { map:building_textures[3], color: 0xffffff, ambient: 0x777777, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } ),
	  new THREE.MeshPhongMaterial( { map:building_textures[4], color: 0xffffff, ambient: 0x777777, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } )
	];

	var roof_texture = THREE.ImageUtils.loadTexture("images/roof.jpg");
	roof_texture.repeat.set(4,4);
	roof_texture.wrapS = roof_texture.wrapT = THREE.RepeatWrapping;
	var roof_material=new THREE.MeshPhongMaterial( { map:roof_texture, color: 0xffffff, ambient: 0x777777, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } );


	var lvlString=maps[lvl].mapString,
	  cubes=[], cube, roof, roofs=false,
	  i=0,h,z,
	  c, x=0, y=0, matrix, zou, zde=0, cumulated_c="", texture_indice;	
	collider=[[]];
	for (i=0; i<building_materials.length; i++) cubes.push(false);

	for (i=0; i<lvlString.length; i++){
	  c=lvlString.charAt(i);
	  if (c=="\n" || c==" ") continue;
	  c=(c=="A")?"10":c;
	  c=(c=="BA")?"11":c;
	  c=(c=="C")?"12":c;
	  c=(c=="D")?"13":c;
	  c=(c=="E")?"14":c;
	  c=(c=="F")?"15":c;
	  c=parseInt(c).toString(2);
	  while(c.length<4) c="0"+c;
	  cumulated_c=c+cumulated_c;
	  zde++;
	  if (zde<maps[lvl].charsPerElement) {	    
	    continue;
	  }  	  
	  zde=0;
	  zou=[];
	  for (h=0; h<cumulated_c.length; h++) {
	    z=(h-y*Math.sin(slope)-cumulated_c.length);
	    if (cumulated_c.charAt(cumulated_c.length-h-1)==="0") {
	      zou.push(false);
	      continue;
	    }
	    zou.push(true);

	    //cube=new THREE.CubeGeometry( cubeScale, cubeScale, cubeScale );
	    cube=THREE.GeometryUtils.clone(cubeGeometry);
	    roof=THREE.GeometryUtils.clone(roofGeometry);

	    texture_indice=Math.floor(Math.random()*building_materials.length);	    
	    matrix.makeTranslation((x-width/2)*cubeScale,z*cubeScale,y*cubeScale);
	    cube.applyMatrix(matrix);
	    roof.applyMatrix(matrix);

	    if (roofs) {
	      THREE.GeometryUtils.merge(roofs, roof);
	    } else {
	      roofs=roof;
	    }

	    if (cubes[texture_indice]) {
		THREE.GeometryUtils.merge(cubes[texture_indice], cube);
	    } else {
		cubes[texture_indice]=cube;
	    }
	  }	  
	  collider[y][x]=zou;
	  x++;
	  cumulated_c="";
	  if (x>=width) {
	    x=0;
	    y++;
	    collider[y]=[];
	  }
	}
	ymax=y;	
	
	for (i=0; i<cubes.length; i++) {
	    if (!cubes[i]) continue;
	    cubesMesh=new THREE.Mesh(cubes[i], building_materials[i]);
	    cubesMesh.receiveShadow = true;	
	    scene.add(cubesMesh);
	}
	scene.add(new THREE.Mesh(roofs, roof_material));
	
	return true;
      },

      set_ground: function() {
	  var ground_texture = THREE.ImageUtils.loadTexture("images/ground.jpg");
	  ground_texture.repeat.set( width, ymax);
	  ground_texture.wrapS = ground_texture.wrapT = THREE.RepeatWrapping; 
	  var ground_material = new THREE.MeshPhongMaterial( { map:ground_texture, color: 0xffffff, ambient: 0x111111, specular: 0x999999, shininess: 15, shading: THREE.SmoothShading } );
	  var groundGeometry=new THREE.PlaneGeometry(width*cubeScale, cubeScale*ymax/Math.cos(slope));
	  var matrix=new THREE.Matrix4();
	  matrix.makeRotationX(Math.atan(Math.sin(slope)));
	  groundGeometry.applyMatrix(matrix);
	  var groundMesh=new THREE.Mesh(groundGeometry, ground_material);
	  //groundMesh.castShadow = true;
	  groundMesh.receiveShadow = true;
	  
	  //groundMesh.rotation.z=0;
	  //groundMesh.rotation.x=slope;
	  
	  groundMesh.translateZ(ymax*0.5*cubeScale-0.5*cubeScale);
	  groundMesh.translateY((-this.get_lvlHight()-ymax*0.5*Math.sin(slope))*cubeScale);
	  groundMesh.translateX(-0.5*cubeScale);
	  groundMesh.updateMatrix();
	  if (ground) scene.del(ground); 
	  scene.add(groundMesh);
      },

      set_sides: function() {
	

      },

      set_level: function(lvl) {
	this.current=lvl;
	this.parse_level(lvl);
	this.set_ground();
      },

      collide: function(position) {
	  var x=Math.round(position.x/cubeScale+width/2),
	      y=Math.round(position.z/cubeScale);
	  
	  var z=Math.round(this.get_lvlHight()+position.y/cubeScale+y*Math.sin(slope));	
	  if (this.get_lvlHight()*cubeScale+position.y+y*Math.sin(slope)*cubeScale<-0.1*cubeScale) return true;
	  if (x<0 || x>=width) return true;
	  if (y<0) return false;
	  if (y>=collider.length-1) {
	    GAME.win();
	    return false;
	  }
	  return collider[y][x][z];
      },

      get_width: function() { return width; },
      get_slope: function() { return slope; },
      get_zmax: function(y) { return -y*Math.sin(slope); },
      get_lvlHight: function() { return maps[this.current].charsPerElement*4; }
  };
})();
      

var NAVIGATION=(function(){
  var X_sensibility=0.02,  
      Y_sensibility=0.02,
      speed=0.5,
      back=1.08,      
      theta=0,
      gamespeed=50,
      phiMin=-Math.PI/4,
      phi=0;
  var fall=-speed*Math.sin(MAPS.get_slope());
  var keyDowns=[], moveTheta=false, movePhi=false, delta=0;
  return {
    keydown: function(event) {
      event.preventDefault();
      switch(event.keyCode) {                
                case 37: //left arrow
                    NAVIGATION.addKeyDown(37);
                break;
                case 39: //right arrow
                    NAVIGATION.addKeyDown(39);
                break;
                case 38: //up arrow
                    NAVIGATION.addKeyDown(38);
                break;
                case 40: //down arrow
                    NAVIGATION.addKeyDown(40);
                break;
	}
    },

    keyup: function(event) {
      event.preventDefault();
      switch(event.keyCode) {                
                case 37: //left arrow
                    NAVIGATION.delKeyDown(37);
                break;
                case 39: //right arrow
                    NAVIGATION.delKeyDown(39);
                break;
                case 38: //up arrow
                    NAVIGATION.delKeyDown(38);
                break;
                case 40: //down arrow
                    NAVIGATION.delKeyDown(40);
                break;
	}
    },

    addKeyDown: function(keyCode) {
      if (keyDowns.indexOf(keyCode)!==-1) return;
      keyDowns.push(keyCode);
    },

    delKeyDown: function(keyCode) {	
	keyDowns.splice(keyDowns.indexOf(keyCode), 1);
    },

    set: function() {
      document.onkeydown=this.keydown;
      document.onkeyup=this.keyup;  
    },

    unset: function() {
      document.onkeydown=null;
      document.onkeyup=null;
    },

    move: function(keyCode) {
	switch(keyCode) {                
                case 37: //left arrow
                    NAVIGATION.moveXY(1,0);
		    moveTheta=true;
                break;
                case 39: //right arrow
                    NAVIGATION.moveXY(-1,0);
		    moveTheta=true;
                break;
                case 38: //up arrow
                    NAVIGATION.moveXY(0,1);
		    movePhi=true;
                break;
                case 40: //down arrow
                    NAVIGATION.moveXY(0,-1);
		    movePhi=true;
                break;
	}
    },

    moveXY: function(x,y) {
      theta+=x*X_sensibility*delta;
      if (y>0 || phi>phiMin) phi+=y*Y_sensibility*delta;
    },

    update: function(raw_delta) {   
      delta=raw_delta*gamespeed;
      if (!tux) return;
      if (MAPS.collide(tux.position))  {
	GAME.loose();
      }
      moveTheta=false; movePhi=false;
      keyDowns.map(NAVIGATION.move);
      if (!moveTheta) theta/=back;
      if (!movePhi) phi/=back;

      
      if (GAME.running)  {	
	if (MAPS.get_zmax(tux.position.z)<tux.position.y+4){// && Math.sin(phi)<=0.1) { //redresse le zdÃ©
	  //tux.translateY(delta*(fall-speed*0.5));
	  phi+=Y_sensibility*delta+0.04;
	} 
	tux.translateY(delta*(fall-speed*Math.sin(phi)));
	tux.translateZ(delta*(speed*Math.cos(theta)*Math.cos(phi)));
	tux.translateX(delta*speed*Math.sin(theta));               
	
	tux.rotation.y=theta*1.5;
	tux.rotation.x=phi*1.5;
	tux.rotation.z=-theta;
      }

      camera.position.copy(tux.position);
      camera.position.z-=5*(1+Math.sin(-phi/3));
      camera.position.x-=5*Math.sin(theta/3);
      camera.position.y+=3*(1+Math.sin(phi/3));
      camera.lookAt(tux.position);
      
      spotLight.position.copy(tux.position);
      spotLight.position.z-=10;//*(1+Math.sin(-phi));
      spotLight.position.x-=10*Math.sin(theta/3);
      spotLight.position.y+=10*(0.9+Math.sin(phi/3));
      spotLight.lookAt(tux.position);

      shadowLight.position.copy(spotLight.position);
      shadowLight.lookAt(tux.position);
     
      pointLight.position.copy(tux.position);
      pointLight.position.z-=2;
       pointLight.position.y-=10;
      return true;
    },

    reset: function() {
      theta=phi=0;
      tux.position.set(0,0,0);
    }
  }
})();





		var stats, scene, renderer;
		var camera, cameraControl, tux=false, skyboxMesh, spotLight, pointLight, shadowLight, music, crashSound, clock = new THREE.Clock();


		function main() {
		  GAME.init();
		}

		// init the scene
		function init(){

			if( Detector.webgl ){
				renderer = new THREE.WebGLRenderer({
					antialias		: true,	// to get smoother output
					preserveDrawingBuffer	: true	// to allow screenshot
				});
				//renderer.setFaceCulling(false);
				renderer.setClearColorHex( 0xBBBBBB, 1 );
				renderer.shadowMapEnabled = true;
				renderer.shadowMapSoft = true;				

			
			// uncomment if webgl is required
			//}else{
			//	Detector.addGetWebGLMessage();
			//	return true;
			}else{
				renderer	= new THREE.CanvasRenderer();
			}
			renderer.setSize( window.innerWidth, window.innerHeight );			
			document.getElementById('container').appendChild(renderer.domElement);

			//music
			music=document.createElement("audio");
			var sourceMusic=document.createElement("source");
			sourceMusic.src="audio/aryx.ogg";
			music.loop=true;
			music.preload=true;
			music.autoplay=false;
			music.appendChild(sourceMusic);


			crashSound=document.createElement("audio");
			var sourceMusicCrash=document.createElement("source");
			sourceMusicCrash.src="audio/crash.ogg";
			crashSound.loop=false;
			crashSound.preload=true;
			crashSound.autoplay=false;
			crashSound.appendChild(sourceMusicCrash);
			crashSound.onended=crashSound.pause;

    
			// create a scene
			scene = new THREE.Scene();
			scene.fog = new THREE.Fog( 0x000022, 10, 300 );

			// put a camera in the scene
			camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 10000 );

			camera.position.set(0, 0, 5);
			//camera.rotation.y=Math.PI;			
			camera.updateMatrix();
			//camera.lookAt(new THREE.Vector3(0.,0,-1));			
			scene.add(camera);

			THREEx.WindowResize(renderer, camera);

			var loader = new THREE.ColladaLoader();
			loader.options.convertUpAxis = true;
			loader.load( 'tux.dae', function colladaReady( collada ) {

				var tuxScene = collada.scene;
				skin = collada.skins[ 0 ];

				tuxScene.scale.x = tuxScene.scale.y = tuxScene.scale.z = 1;				
				tuxScene.updateMatrix();
				spotLight.target=tuxScene;
				shadowLight.target=tuxScene;
				tux=tuxScene;
				tux.children[0].castShadow = true;
				tux.children[0].receiveShadow = false;	
				//camera.lookAt(tux);
				//camera.updateMatrix();
				scene.add(tux);
			} );

			var textureCube = THREE.ImageUtils.loadTextureCube( ["images/skybox/posx.jpg", "images/skybox/negx.jpg", "images/skybox/posy.jpg", "images/skybox/negy.jpg", "images/skybox/posz.jpg", "images/skybox/negz.jpg"] );
			var shader = THREE.ShaderUtils.lib["cube"];
			//var uniforms = THREE.UniformsUtils.clone( shader.uniforms );
			shader.uniforms[ "tCube" ].texture = textureCube;
			shader.uniforms[ "tFlip" ].texture = -1;
			//uniforms['tCube'].texture= textureCube; // textureCube has been init before
			var cubeMaterial = new THREE.ShaderMaterial({
			  fragmentShader : shader.fragmentShader,
			  vertexShader : shader.vertexShader,
			  uniforms : shader.uniforms,
			  depthWrite: false,			  
			});
			cubeMaterial.overdraw=true;
			
			skyboxMesh = new THREE.Mesh( new THREE.CubeGeometry( 5000, 5000, 5000), cubeMaterial);			
			skyboxMesh.flipSided=true;
			skyboxMesh.castShadow = false;
			skyboxMesh.receiveShadow = false;			
	
			scene.add(skyboxMesh);  			
			
			var ambientLight = new THREE.AmbientLight(0x555555);
			scene.add(ambientLight);


    			pointLight = new THREE.PointLight( 0xff6600, 1, 50 );
			scene.add( pointLight );

			spotLight = new THREE.SpotLight( 0xaaaaaa ,2,0,Math.PI/4, 1);			
			spotLight.position.set( 0, 0, -1 );
			spotLight.castShadow = false;
			scene.add( spotLight );

			shadowLight=new THREE.DirectionalLight(0xaaaaaa, 4, 1);
			shadowLight.position.set( 0, 0, -1 );
			shadowLight.castShadow = true;
			shadowLight.onlyShadow = true;
			shadowLight.shadowCameraNear = 2;
			shadowLight.shadowCameraFar = 200;
			shadowLight.shadowCameraLeft = -10;
			shadowLight.shadowCameraRight = 10;
			shadowLight.shadowCameraTop = 10;
			shadowLight.shadowCameraBottom = -10;
			shadowLight.shadowCameraVisible = false;
			shadowLight.shadowBias = 0;
			shadowLight.shadowDarkness = 0.5;
			shadowLight.shadowMapWidth = 512;
			shadowLight.shadowMapHeight = 512;
			scene.add( shadowLight );
		}

		// animation loop
		function animate() {

			// loop on request animation loop
			// - it has to be at the begining of the function
			// - see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
			requestAnimationFrame( animate );

			// do the render
			render();

		}

		// render the scene
		function render() {

			// update camera controls
			//cameraControls.update();
			NAVIGATION.update(clock.getDelta());

			// actually render the scene
			
			renderer.render( scene, camera );
		}
	</script>
	</head>
<body onload="main()">

<div id="container"></div>

<div class='windoz' id='win'>
  <h1>Congratulations !</h1>
  <h2>You win :)</h2>
  <div class='petit'>Sorry for this cheap end ;)</div><br/>
  <a href='#' onclick="GAME.restart()">Replay</a>
</div>

<div class='windoz' id='loose'>
  <img src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT2Iu_BbvCBqbXSr8Yfa9wDYVPbY_YFni6D9w&s' style='float: right'/>
  <h1>NOOB !</h1>  
  <a href='#' onclick="GAME.restart()">Replay</a>
</div>

<div class='windoz' id='start'>
  <h1>Teach me to Fly</h1>
  <img src='data:image/jpeg;base64,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' style='float: right'/>
  <p>Teach Tux how to fly between buildings with its wingsuit. Use the directionnal keyboard touches to control the direction.</p>  
  <a href='#' onclick="GAME.start()">Start</a>
</div>

</body>
</html>
